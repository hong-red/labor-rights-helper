<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ³åŠ¨ç»´æƒå¸®åŠ©åŠ©æ‰‹</title>
    
    <link rel="stylesheet" href="css/style.css">
    <script type="text/javascript">
        window._AMapSecurityConfig = {
            securityJsCode: 'b644c2876d8163c35f230c3e6e0bf83b'
        }
    </script>
    <script src="https://webapi.amap.com/loader.js"></script>
    <style>
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 20px;
            padding: 10px;
        }
        .page-btn {
            padding: 8px 12px;
            border: 1px solid #007bff;
            border-radius: 5px;
            background-color: white;
            color: #007bff;
            cursor: pointer;
            transition: all 0.3s;
        }
        .page-btn:hover {
            background-color: #e7f1ff;
        }
        .page-btn.active {
            background-color: #007bff;
            color: white;
        }
        .page-btn:disabled {
            background-color: #f0f0f0;
            color: #666666;
            border-color: #cccccc;
            cursor: not-allowed;
        }
        #nearby-centers {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #fff;
        }
        .poi-item {
            margin-bottom: 15px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .legal-aid-pinned {
            border-left: 4px solid #ff4d4f;
            background-color: #fff1f0;
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .pinned-tag {
            background: #ff4d4f;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            margin-bottom: 8px;
            display: inline-block;
        }
    </style>
</head>
<body>
    <header class="hero-section">
        <div class="hero-content">
            <h1>åŠ³åŠ¨ç»´æƒå¸®åŠ©åŠ©æ‰‹</h1>
            <p class="subtitle">æ‚¨çš„æ³•å¾‹æ´åŠ©ä¸ç»´æƒæŒ‡å—</p>
        </div>
    </header>
    <main>
        <div class="container">
            <section id="usage-instructions">
                <h2>å¦‚ä½•å¯»æ±‚æ³•å¾‹å¸®åŠ©</h2>
                <p>æœ¬é¡µé¢æ—¨åœ¨ä¸ºæ‚¨æä¾›ä¾¿æ·çš„æ³•å¾‹æ´åŠ©ä¿¡æ¯æŸ¥è¯¢æœåŠ¡ã€‚æ‚¨å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼è·å–å¸®åŠ©ï¼š</p>
                <ul>
                    <li><strong>æŸ¥æ‰¾æ³•å¾‹æ´åŠ©ä¸­å¿ƒï¼š</strong> é€‰æ‹©æ‚¨æ‰€åœ¨çš„çœä»½ï¼Œæˆ–ç‚¹å‡»â€œè·å–æˆ‘çš„ä½ç½®å¹¶æ¨èâ€ï¼Œæˆ‘ä»¬å°†ä¸ºæ‚¨å±•ç¤ºé™„è¿‘çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒã€‚</li>
                    <li><strong>è®¿é—®å’¨è¯¢ç½‘ç«™ï¼š</strong> é€‰æ‹©çœä»½åï¼Œé¡µé¢ä¸‹æ–¹ä¼šæ˜¾ç¤ºè¯¥çœä»½çš„æ³•å¾‹æ´åŠ©å’¨è¯¢ç½‘ç«™é“¾æ¥ï¼Œæ‚¨å¯ä»¥ç‚¹å‡»è®¿é—®è·å–åœ¨çº¿å¸®åŠ©ã€‚</li>
                    <li><strong>è”ç³»æ£€å¯Ÿé™¢ï¼š</strong> å¦‚æœæ‚¨éœ€è¦å‘æ£€å¯Ÿé™¢åæ˜ é—®é¢˜æˆ–å¯»æ±‚å¸®åŠ©ï¼Œå¯ä»¥è®¿é—® <a href="https://www.12309.gov.cn/" target="_blank">12309ä¸­å›½æ£€å¯Ÿç½‘</a> è·å–ç›¸å…³ä¿¡æ¯ã€‚</li>
                    <li><strong>å‘¨è¾¹é…’åº—æœç´¢ï¼š</strong> å¦‚æœæ‚¨åœ¨å¼‚åœ°å¯»æ±‚æ³•å¾‹å¸®åŠ©ï¼Œéœ€è¦ä¸´æ—¶ä½å®¿ï¼Œå¯ä»¥ä½¿ç”¨â€œå‘¨è¾¹æœç´¢é…’åº—â€åŠŸèƒ½æŸ¥æ‰¾é™„è¿‘çš„é…’åº—ã€‚</li>
                </ul>
                <p>è¯·æ³¨æ„ï¼šæœ¬é¡µé¢æä¾›çš„ä¿¡æ¯ä»…ä¾›å‚è€ƒï¼Œå…·ä½“æ³•å¾‹é—®é¢˜è¯·å’¨è¯¢ä¸“ä¸šå¾‹å¸ˆæˆ–æ³•å¾‹æ´åŠ©æœºæ„ã€‚</p>
            </section>
            <section id="lawyer-info">
                <h2>å¾‹å¸ˆæ¨èä¸å’¨è¯¢</h2>
                <p>è¿™é‡Œå°†å±•ç¤ºå¾‹å¸ˆæ¨èã€å’¨è¯¢æœåŠ¡ç­‰ç›¸å…³å†…å®¹ã€‚</p>
                <div class="card">
                    <h2>ç¦»ä½ æœ€è¿‘çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒ</h2>
                    <div style="margin-bottom: 10px;">
                        <label for="province-select">é€‰æ‹©çœä»½ï¼š</label>
                        <select id="province-select" onchange="filterCentersByProvince()">
                            <option value="">æ‰€æœ‰çœä»½</option>
                        </select>
                    </div>
                    <div id="consultation-website" style="margin-bottom: 10px;"></div>
                    <button id="get-location-button" onclick="getAndShowNearbyAid()" disabled>è·å–æˆ‘çš„ä½ç½®å¹¶æ¨è</button>
                    <button onclick="searchNearbyHotels()" style="margin-left: 10px;">å‘¨è¾¹æœç´¢é…’åº—</button>
                    <div id="nearby-centers">ç‚¹å‡»æŒ‰é’®è·å–</div>
                    <div id="map-container" style="width: 100%; height: 400px; margin-top: 20px;"></div>
                </div>
            </section>
        </div>
    </main>
    <script src="js/data.js"></script>
    <script>
        let map = null;
        let markers = [];
        let userLocation = null;
        let userMarker = null; // æ–°å¢ï¼šç”¨æˆ·ä½ç½®æ ‡è®°

        function showError(error) {
            console.error('åœ°å›¾æˆ–å®šä½å¤±è´¥:', error);
            document.getElementById('nearby-centers').innerHTML = `<p>åœ°å›¾åŠ è½½æˆ–å®šä½å¤±è´¥ï¼Œå°†æ˜¾ç¤ºé»˜è®¤åˆ—è¡¨ã€‚è¯·è®¿é—® <a href="https://www.12348.gov.cn/" target="_blank">ä¸­å›½æ³•å¾‹æœåŠ¡ç½‘</a> æŸ¥è¯¢ã€‚</p>`;
            displayLegalAidCenters(); // Fallback to static list
        }

        function clearMarkers() {
            map.remove(markers);
            markers = [];
        }

        // æ–°å¢ï¼šæ¸…é™¤ç”¨æˆ·ä½ç½®æ ‡è®°
        function clearUserMarker() {
            if (userMarker) {
                map.remove(userMarker);
                userMarker = null;
            }
        }

        function addMarker(center) {
            const marker = new AMap.Marker({
                position: new AMap.LngLat(center.lng, center.lat),
                title: center.name,
                map: map
            });

            const tel = center.phone ? `<br>ç”µè¯ï¼š<a href="tel:${center.phone}">${center.phone}</a>` : '';
            const amapNavUrl = `https://uri.amap.com/navigation?to=${center.lng},${center.lat},${center.name}&mode=walk&callnative=1`;

            const infoWindowContent = `
                <div style="padding:10px; font-size:14px;">
                    <strong>${center.name}</strong><br>
                    åœ°å€ï¼š${center.address}${tel}<br>
                    <a href="${amapNavUrl}" target="_blank" style="color:#007bff;">é«˜å¾·åœ°å›¾å¯¼èˆª</a>
                </div>`;

            const infoWindow = new AMap.InfoWindow({
                content: infoWindowContent,
                offset: new AMap.Pixel(0, -30)
            });

            marker.on('click', () => {
                infoWindow.open(map, marker.getPosition());
            });

            markers.push(marker);
        }

        function populateProvinces() {
            const provinceSelect = document.getElementById('province-select');
            provinceSelect.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

            // æ·»åŠ ä¸€ä¸ªé»˜è®¤çš„â€œè¯·é€‰æ‹©çœä»½â€é€‰é¡¹
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'è¯·é€‰æ‹©çœä»½';
            provinceSelect.appendChild(defaultOption);

            // ä»ç»´æƒæ•°æ®.provincesä¸­è·å–æ‰€æœ‰çœä»½å¹¶æ’åº
            const sortedProvinces = Object.keys(ç»´æƒæ•°æ®.provinces).sort((a, b) => {
                return ç»´æƒæ•°æ®.provinces[a].name.localeCompare(ç»´æƒæ•°æ®.provinces[b].name, 'zh-CN');
            });

            sortedProvinces.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = ç»´æƒæ•°æ®.provinces[code].name;
                provinceSelect.appendChild(option);
            });
        }

        let currentProvinceSearchPage = 1; // Global variable for province search pagination

        function filterCentersByProvince(page = 1) {
            const provinceSelect = document.getElementById('province-select');
            const selectedProvinceCode = provinceSelect.value;
            displayConsultationWebsite(selectedProvinceCode); // æ˜¾ç¤ºå’¨è¯¢ç½‘ç«™

            const nearbyCentersDiv = document.getElementById('nearby-centers');
            nearbyCentersDiv.innerHTML = '<p>æ­£åœ¨æœç´¢æŒ‡å®šçœä»½çš„æ³•å¾‹æœåŠ¡æœºæ„...</p>';

            if (!map) {
                showError('åœ°å›¾æœªåˆå§‹åŒ–');
                return;
            }

            if (!selectedProvinceCode) {
                nearbyCentersDiv.innerHTML = '<p>è¯·é€‰æ‹©ä¸€ä¸ªçœä»½æ¥æœç´¢æ³•å¾‹æœåŠ¡æœºæ„ã€‚</p>';
                clearMarkers();
                return;
            }

            const provinceData = ç»´æƒæ•°æ®.provinces[selectedProvinceCode];
            const provinceName = provinceData.name;
            currentProvinceSearchPage = page;

            // 1. å…ˆé€šè¿‡ PlaceSearch æœç´¢è¯¥çœæœ€æƒå¨çš„â€œæ³•å¾‹æ´åŠ©ä¸­å¿ƒâ€ä½œä¸ºç½®é¡¶
            const aidSearch = new AMap.PlaceSearch({
                pageSize: 1,
                pageIndex: 1,
                city: provinceName,
                autoFitView: false // ä¸è‡ªåŠ¨ç¼©æ”¾ï¼Œç•™ç»™åé¢çš„å¾‹å¸ˆäº‹åŠ¡æ‰€æœç´¢å¤„ç†
            });

            // æœç´¢è¯ï¼šçœå + æ³•å¾‹æ´åŠ©ä¸­å¿ƒ
            const aidQuery = provinceName + 'æ³•å¾‹æ´åŠ©ä¸­å¿ƒ';

            aidSearch.search(aidQuery, (status, result) => {
                nearbyCentersDiv.innerHTML = ''; // æ¸…ç©ºåŠ è½½æç¤º

                let pinnedPoiHtml = '';
                if (status === 'complete' && result.poiList && result.poiList.pois.length > 0) {
                    const poi = result.poiList.pois[0];
                    pinnedPoiHtml = `
                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ffccc7;">
                            <strong style="font-size: 0.9em; color: #333;">åœ°å€ï¼š${poi.address}</strong><br>
                            <div style="margin-top: 8px;">
                                <a href="#" onclick="map.setCenter([${poi.location.lng}, ${poi.location.lat}]); map.setZoom(15); return false;" style="color:#28a745; text-decoration: none; font-size: 0.9em;">ğŸ“ åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹</a>
                                <span style="margin: 0 8px; color: #ccc;">|</span>
                                <a href="https://uri.amap.com/navigation?to=${poi.location.lng},${poi.location.lat},${poi.name}&mode=walk&callnative=1" target="_blank" style="color:#007bff; text-decoration: none; font-size: 0.9em;">ğŸš— é«˜å¾·åœ°å›¾å¯¼èˆª</a>
                            </div>
                        </div>
                    `;
                }

                // åˆ›å»ºç½®é¡¶æ¨¡å—
                const pinnedDiv = document.createElement('div');
                pinnedDiv.className = 'legal-aid-pinned';
                
                let phonesHtml = '';
                if (provinceData.phones) {
                    for (const [name, phone] of Object.entries(provinceData.phones)) {
                        phonesHtml += `<div><strong>${name}ï¼š</strong><a href="tel:${phone}">${phone}</a></div>`;
                    }
                }

                pinnedDiv.innerHTML = `
                    <div class="pinned-tag">å®˜æ–¹æ³•å¾‹æ´åŠ©ä¸­å¿ƒï¼ˆæœ¬çœç½®é¡¶ï¼‰</div>
                    <h3 style="margin: 0 0 10px 0; color: #d32f2f;">${provinceName}æ³•å¾‹æ´åŠ©ä¸­å¿ƒ</h3>
                    <div style="font-size: 0.95em; line-height: 1.6;">
                        ${phonesHtml || 'æš‚æ— ç”µè¯ä¿¡æ¯'}
                        ${pinnedPoiHtml}
                        <div style="margin-top: 10px; color: #666; font-size: 0.85em;">æ³¨ï¼šä»¥ä¸Šä¸ºè¯¥çœä»½å®˜æ–¹æœºæ„ï¼Œå»ºè®®ä¼˜å…ˆæ‹¨æ‰“ç”µè¯å’¨è¯¢ã€‚</div>
                    </div>
                `;
                nearbyCentersDiv.appendChild(pinnedDiv);

                // 2. ç»§ç»­æ‰§è¡ŒåŸæœ‰çš„â€œå¾‹å¸ˆäº‹åŠ¡æ‰€â€åˆ†é¡µæœç´¢
                searchLawyers(provinceName, page, nearbyCentersDiv);
            });
        }

        // æ‹†åˆ†å‡ºæœç´¢å¾‹å¸ˆçš„å‡½æ•°
        function searchLawyers(provinceName, page, container) {
            const placeSearch = new AMap.PlaceSearch({
                pageSize: 3,
                pageIndex: page,
                city: provinceName,
                map: map,
                autoFitView: true
            });

            const searchQuery = (provinceName === 'é¦™æ¸¯' || provinceName === 'æ¾³é—¨') ? 'å¾‹å¸ˆ' : 'å¾‹å¸ˆäº‹åŠ¡æ‰€';

            placeSearch.search(searchQuery, (status, result) => {
                if (status === 'complete' && result.info === 'OK') {
                    const resultsHeader = document.createElement('p');
                    resultsHeader.style.borderBottom = '1px solid #eee';
                    resultsHeader.style.paddingBottom = '10px';
                    resultsHeader.style.marginTop = '20px';
                    resultsHeader.innerHTML = `<strong>${provinceName}çš„${searchQuery} (ç¬¬ ${page} é¡µ)</strong>`;
                    container.appendChild(resultsHeader);

                    if (result.poiList && result.poiList.pois.length > 0) {
                        result.poiList.pois.forEach(poi => {
                            const poiDiv = document.createElement('div');
                            poiDiv.className = 'poi-item';
                            poiDiv.innerHTML = `
                                <strong style="color: #333;">${poi.name}</strong><br>
                                <span style="font-size: 0.9em; color: #666;">åœ°å€ï¼š${poi.address}</span><br>
                                <span style="font-size: 0.9em; color: #666;">ç”µè¯ï¼š${poi.tel || 'æš‚æ— '}</span><br>
                                <div style="margin-top: 8px;">
                                    <a href="#" onclick="map.setCenter([${poi.location.lng}, ${poi.location.lat}]); map.setZoom(15); return false;" style="color:#28a745; text-decoration: none; font-size: 0.9em;">ğŸ“ åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹</a>
                                    <span style="margin: 0 8px; color: #ccc;">|</span>
                                    <a href="https://uri.amap.com/navigation?to=${poi.location.lng},${poi.location.lat},${poi.name}&mode=walk&callnative=1" target="_blank" style="color:#007bff; text-decoration: none; font-size: 0.9em;">ğŸš— é«˜å¾·åœ°å›¾å¯¼èˆª</a>
                                </div>
                            `;
                            container.appendChild(poiDiv);
                        });
                    } else {
                        container.innerHTML += `<p>æœªåœ¨${provinceName}æ‰¾åˆ°ç›¸å…³çš„${searchQuery}ã€‚</p>`;
                    }

                    // ç¿»é¡µæ§ä»¶
                    const totalPages = Math.ceil(result.poiList.count / 3);
                    if (totalPages > 1) {
                        const paginationDiv = document.createElement('div');
                        paginationDiv.className = 'pagination-container';

                        const prevButton = document.createElement('button');
                        prevButton.className = 'page-btn';
                        prevButton.textContent = 'ä¸Šä¸€é¡µ';
                        prevButton.disabled = page <= 1;
                        prevButton.onclick = () => filterCentersByProvince(page - 1);
                        paginationDiv.appendChild(prevButton);

                        const startPage = Math.max(1, page - 2);
                        const endPage = Math.min(totalPages, startPage + 4);
                        for (let i = (endPage - startPage < 4 ? Math.max(1, endPage - 4) : startPage); i <= endPage; i++) {
                            if (i < 1) continue;
                            const pageButton = document.createElement('button');
                            pageButton.className = `page-btn ${i === page ? 'active' : ''}`;
                            pageButton.textContent = i;
                            pageButton.onclick = () => filterCentersByProvince(i);
                            paginationDiv.appendChild(pageButton);
                        }

                        const nextButton = document.createElement('button');
                        nextButton.className = 'page-btn';
                        nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                        nextButton.disabled = page >= totalPages;
                        nextButton.onclick = () => filterCentersByProvince(page + 1);
                        paginationDiv.appendChild(nextButton);

                        container.appendChild(paginationDiv);
                    }

                    const footer = document.createElement('p');
                    footer.style.textAlign = 'center';
                    footer.style.fontSize = '0.8em';
                    footer.style.color = '#999';
                    footer.style.marginTop = '15px';
                    footer.innerHTML = `å…±æ‰¾åˆ° ${result.poiList.count} å®¶æœºæ„ï¼Œç¬¬ ${page}/${totalPages} é¡µ`;
                    container.appendChild(footer);
                } else {
                    const errorMsg = document.createElement('p');
                    errorMsg.innerHTML = `æœç´¢å¤±è´¥æˆ–æ— æ•°æ®ã€‚å¦‚æœæ‚¨åœ¨${provinceName}ï¼Œå»ºè®®ç›´æ¥æ‹¨æ‰“ä¸Šæ–¹æ³•å¾‹æ´åŠ©ç”µè¯å’¨è¯¢ã€‚`;
                    container.appendChild(errorMsg);
                }
            });
        }

        // æ–°å¢ï¼šæ˜¾ç¤ºå’¨è¯¢ç½‘ç«™
        function displayConsultationWebsite(provinceCode) {
            const websiteDiv = document.getElementById('consultation-website');
            if (websiteDiv) {
                if (provinceCode && ç»´æƒæ•°æ®.consultationWebsites[provinceCode]) {
                    const site = ç»´æƒæ•°æ®.consultationWebsites[provinceCode];
                    websiteDiv.innerHTML = `<p><strong>${ç»´æƒæ•°æ®.provinces[provinceCode].name}æ³•å¾‹æ´åŠ©å’¨è¯¢ç½‘ç«™ï¼š</strong> <a href="${site.url}" target="_blank">${site.name}</a></p>`;
                } else {
                    websiteDiv.innerHTML = ''; // æ¸…ç©º
                }
            }
        }

        function initMap() {
            AMapLoader.load({
                key: '2bebdb0b3275d92dc2bd9d8dde2eb4c8',
                version: '2.0',
                plugins: ['AMap.Scale', 'AMap.ToolBar', 'AMap.Geolocation', 'AMap.PlaceSearch', 'AMap.CitySearch']
            }).then((AMap) => {
                map = new AMap.Map('map-container', {
                    zoom: 5,
                    center: [116.397428, 39.90923] // Default center
                });
                map.addControl(new AMap.Scale());
                map.addControl(new AMap.ToolBar());

                document.getElementById('get-location-button').disabled = false; // å¯ç”¨æŒ‰é’®

                // Initial display
                // é»˜è®¤ä¸æ˜¾ç¤ºä»»ä½•æ³•å¾‹æ´åŠ©ä¸­å¿ƒï¼Œç­‰å¾…ç”¨æˆ·é€‰æ‹©çœä»½æˆ–ç‚¹å‡»å®šä½
                // displayLegalAidCenters();
                displayConsultationWebsite(''); // åˆå§‹ä¸æ˜¾ç¤ºå’¨è¯¢ç½‘ç«™

            }).catch(e => {
                console.error(e);
                showError(e);
            });
        }

        // æ–°å¢ï¼šæœç´¢é™„è¿‘é…’åº—çš„å‡½æ•°
        function searchNearbyHotels() {
            if (!userLocation) {
                alert('è¯·å…ˆç‚¹å‡»â€œè·å–æˆ‘çš„ä½ç½®å¹¶æ¨èâ€ä»¥è·å–æ‚¨çš„ä½ç½®ã€‚');
                return;
            }

            const nearbyCentersDiv = document.getElementById('nearby-centers');
            nearbyCentersDiv.innerHTML = '<p>æ­£åœ¨æœç´¢é™„è¿‘çš„é…’åº—...</p>';

            const placeSearch = new AMap.PlaceSearch({
                pageSize: 3,
                pageIndex: 1,
                city: 'å…¨å›½',
                map: map,
                // panel: "nearby-centers", // ç§»é™¤ panel é€‰é¡¹
                autoFitView: true
            });

            placeSearch.searchNearBy('é…’åº—', userLocation, 10000, (status, result) => {
                if (status === 'complete' && result.info === 'OK') {
                    const panelElement = document.getElementById('nearby-centers');
                    panelElement.innerHTML = ''; // Clear previous results

                    const header = document.createElement('p');
                    header.style.borderBottom = '1px solid #eee';
                    header.style.paddingBottom = '10px';
                    header.innerHTML = `<strong>æ‚¨é™„è¿‘ 10 å…¬é‡Œå†…çš„é…’åº—</strong>`;
                    panelElement.appendChild(header);

                    if (result.poiList && result.poiList.pois.length > 0) {
                        result.poiList.pois.forEach(poi => {
                            const poiDiv = document.createElement('div');
                            poiDiv.className = 'poi-item';
                            poiDiv.style.borderLeftColor = '#ffc107'; // é…’åº—ä½¿ç”¨é»„è‰²è¾¹æ¡†
                            poiDiv.innerHTML = `
                                <strong style="color: #333;">${poi.name}</strong><br>
                                <span style="font-size: 0.9em; color: #666;">åœ°å€ï¼š${poi.address}</span><br>
                                <span style="font-size: 0.9em; color: #666;">ç”µè¯ï¼š${poi.tel || 'æš‚æ— '}</span><br>
                                <div style="margin-top: 8px;">
                                    <a href="#" onclick="map.setCenter([${poi.location.lng}, ${poi.location.lat}]); map.setZoom(15); return false;" style="color:#28a745; text-decoration: none; font-size: 0.9em;">ğŸ“ åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹</a>
                                    <span style="margin: 0 8px; color: #ccc;">|</span>
                                    <a href="https://uri.amap.com/navigation?to=${poi.location.lng},${poi.location.lat},${poi.name}&mode=walk&callnative=1" target="_blank" style="color:#007bff; text-decoration: none; font-size: 0.9em;">ğŸš— é«˜å¾·åœ°å›¾å¯¼èˆª</a>
                                </div>
                            `;
                            panelElement.appendChild(poiDiv);
                        });
                    } else {
                        panelElement.innerHTML += '<p>æœªæ‰¾åˆ°é™„è¿‘é…’åº—ã€‚</p>';
                    }

                    const footer = document.createElement('p');
                    footer.style.textAlign = 'center';
                    footer.style.fontSize = '0.8em';
                    footer.style.color = '#999';
                    footer.style.marginTop = '15px';
                    footer.innerHTML = `æ•°æ®æ¥æºäºé«˜å¾·åœ°å›¾ã€‚`;
                    panelElement.appendChild(footer);
                } else {
                    document.getElementById('nearby-centers').innerHTML = `<p>æœç´¢é…’åº—å¤±è´¥ï¼š${result.info || 'æœªçŸ¥é”™è¯¯'}</p>`;
                    console.error('æœç´¢é…’åº—å¤±è´¥:', result);
                }
            });
        }

        let currentNearbyAidSearchPage = 1; // Global variable for nearby aid search pagination

        function getAndShowNearbyAid(page = 1) {
            document.getElementById('nearby-centers').innerHTML = '<p>æ­£åœ¨è·å–æ‚¨çš„ä½ç½®å¹¶æœç´¢é™„è¿‘çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒ...</p>';
            if (!map) {
                showError('åœ°å›¾æœªåˆå§‹åŒ–');
                return;
            }

            const geolocation = new AMap.Geolocation({
                enableHighAccuracy: true,
                timeout: 20000,
                zoomToAccuracy: true,
                showButton: false,
                showMarker: false,
            });

            map.add(geolocation);
            geolocation.getCurrentPosition((status, result) => {
                if (status === 'complete') {
                    userLocation = result.position;
                    map.setCenter(userLocation);
                    clearUserMarker();
                    userMarker = new AMap.Marker({
                        position: userLocation,
                        map: map,
                        icon: 'https://webapi.amap.com/theme/v1.3/markers/n/mark_bs.png',
                        title: 'æˆ‘çš„ä½ç½®'
                    });

                    currentNearbyAidSearchPage = page;

                    // ä½¿ç”¨ AMap.PlaceSearch æœç´¢é™„è¿‘çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒ
                    const placeSearch = new AMap.PlaceSearch({
                        pageSize: 3, // æ˜¾ç¤º3ä¸ªç»“æœ
                        pageIndex: currentNearbyAidSearchPage,
                        city: 'å…¨å›½', // å¯ä»¥åœ¨è¿™é‡ŒæŒ‡å®šåŸå¸‚ï¼Œæˆ–è€…æ ¹æ®userLocationçš„åŸå¸‚ä¿¡æ¯
                        map: map,
                        // panel: "nearby-centers", // ç§»é™¤ panel é€‰é¡¹
                        autoFitView: true
                    });

                    placeSearch.searchNearBy('æ³•å¾‹æ´åŠ©ä¸­å¿ƒ', userLocation, 10000, (searchStatus, searchResult) => {
                        if (searchStatus === 'complete' && searchResult.info === 'OK') {
                            const panelElement = document.getElementById('nearby-centers');
                            panelElement.innerHTML = ''; // Clear previous results

                            const header = document.createElement('p');
                            header.style.borderBottom = '1px solid #eee';
                            header.style.paddingBottom = '10px';
                            header.innerHTML = `<strong>æ‚¨é™„è¿‘ 10 å…¬é‡Œå†…çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒ (ç¬¬ ${currentNearbyAidSearchPage} é¡µ)</strong>`;
                            panelElement.appendChild(header);

                            // Add results from PlaceSearch
                            if (searchResult.poiList && searchResult.poiList.pois.length > 0) {
                                searchResult.poiList.pois.forEach(poi => {
                                    const poiDiv = document.createElement('div');
                                    poiDiv.className = 'poi-item';
                                    poiDiv.innerHTML = `
                                        <strong style="color: #333;">${poi.name}</strong><br>
                                        <span style="font-size: 0.9em; color: #666;">åœ°å€ï¼š${poi.address}</span><br>
                                        <span style="font-size: 0.9em; color: #666;">ç”µè¯ï¼š${poi.tel || 'æš‚æ— '}</span><br>
                                        <div style="margin-top: 8px;">
                                            <a href="#" onclick="map.setCenter([${poi.location.lng}, ${poi.location.lat}]); map.setZoom(15); return false;" style="color:#28a745; text-decoration: none; font-size: 0.9em;">ğŸ“ åœ¨åœ°å›¾ä¸ŠæŸ¥çœ‹</a>
                                            <span style="margin: 0 8px; color: #ccc;">|</span>
                                            <a href="https://uri.amap.com/navigation?to=${poi.location.lng},${poi.location.lat},${poi.name}&mode=walk&callnative=1" target="_blank" style="color:#007bff; text-decoration: none; font-size: 0.9em;">ğŸš— é«˜å¾·åœ°å›¾å¯¼èˆª</a>
                                        </div>
                                    `;
                                    panelElement.appendChild(poiDiv);
                                });
                            } else {
                                panelElement.innerHTML += '<p>æœªæ‰¾åˆ°ç›¸å…³æ³•å¾‹æ´åŠ©ä¸­å¿ƒã€‚</p>';
                            }

                            // Add pagination controls
                            const totalPages = Math.ceil(searchResult.poiList.count / placeSearch.getOptions().pageSize);
                            if (totalPages > 1) {
                                const paginationDiv = document.createElement('div');
                                paginationDiv.className = 'pagination-container';

                                // Previous Button
                                const prevButton = document.createElement('button');
                                prevButton.className = 'page-btn';
                                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                                prevButton.disabled = currentNearbyAidSearchPage <= 1;
                                prevButton.onclick = () => getAndShowNearbyAid(currentNearbyAidSearchPage - 1);
                                paginationDiv.appendChild(prevButton);

                                // Page number buttons
                                const startPage = Math.max(1, currentNearbyAidSearchPage - 2);
                                const endPage = Math.min(totalPages, startPage + 4);
                                
                                for (let i = (endPage - startPage < 4 ? Math.max(1, endPage - 4) : startPage); i <= endPage; i++) {
                                    const pageButton = document.createElement('button');
                                    pageButton.className = `page-btn ${i === currentNearbyAidSearchPage ? 'active' : ''}`;
                                    pageButton.textContent = i;
                                    pageButton.onclick = () => getAndShowNearbyAid(i);
                                    paginationDiv.appendChild(pageButton);
                                }

                                // Next Button
                                const nextButton = document.createElement('button');
                                nextButton.className = 'page-btn';
                                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                                nextButton.disabled = currentNearbyAidSearchPage >= totalPages;
                                nextButton.onclick = () => getAndShowNearbyAid(currentNearbyAidSearchPage + 1);
                                paginationDiv.appendChild(nextButton);

                                panelElement.appendChild(paginationDiv);
                            }

                            const footer = document.createElement('p');
                            footer.style.textAlign = 'center';
                            footer.style.fontSize = '0.8em';
                            footer.style.color = '#999';
                            footer.style.marginTop = '15px';
                            footer.innerHTML = `å…± ${searchResult.poiList.count} æ¡ç»“æœï¼Œç¬¬ ${currentNearbyAidSearchPage}/${totalPages} é¡µ`;
                            panelElement.appendChild(footer);
                        } else {
                            document.getElementById('nearby-centers').innerHTML = `<p>æœç´¢æ³•å¾‹æ´åŠ©ä¸­å¿ƒå¤±è´¥ï¼š${searchResult.info || 'æœªçŸ¥é”™è¯¯'}</p>`;
                            console.error('æœç´¢æ³•å¾‹æ´åŠ©ä¸­å¿ƒå¤±è´¥:', searchResult);
                        }
                    });

                } else {
                    showError(result);
                }
            });
        }

        // è®¡ç®—è·ç¦»å‡½æ•° (ä¸å†éœ€è¦ï¼Œå› ä¸ºä½¿ç”¨ PlaceSearch)
        // function getDistance(lat1, lon1, lat2, lon2) { ... }

        // æ–°å¢ï¼šæ˜¾ç¤ºå¸¦æœ‰è·ç¦»ä¿¡æ¯çš„æ³•å¾‹æ´åŠ©ä¸­å¿ƒ (ä¸å†éœ€è¦ï¼Œå› ä¸ºä½¿ç”¨ PlaceSearch)
        // function displayLegalAidCentersWithDistance(centers) { ... }

        document.addEventListener('DOMContentLoaded', () => {
            populateProvinces(); // ç¡®ä¿åœ¨åœ°å›¾åˆå§‹åŒ–å‰å¡«å……çœä»½ä¸‹æ‹‰èœå•
            initMap();
            filterCentersByProvince(); // åˆå§‹åŠ è½½æ—¶æ ¹æ®é»˜è®¤é€‰æ‹©çš„çœä»½è¿‡æ»¤ä¸­å¿ƒ
        });
    </script>
    <footer>
        <p>&copy; 2026 åŠ³åŠ¨ç»´æƒå¸®åŠ©åŠ©æ‰‹</p>
    </footer>
</body>
</html>